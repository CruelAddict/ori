asyncapi: 3.0.0
info:
  title: Ori Event Stream
  version: 1.0.0
  description: |
    Server-Sent Events (SSE) channel used by ori-tui to receive backend lifecycle
    notifications (connection state changes, errors, etc.).
servers:
  tcp:
    host: localhost:8080
    protocol: http
    security: []
    description: JSON-RPC HTTP server that also exposes the /events SSE endpoint.
  unix:
    host: /var/run/ori.sock
    protocol: http+unix
    bindings:
      http:
        bindingVersion: 0.2.0
    description: Unix domain socket served by ori-be when started with --socket.
channels:
  connectionState:
    address: /events
    messages:
      connectionState:
        $ref: '#/components/messages/ConnectionState'
    description: |
      Continuous SSE stream. Each dispatch uses the `connection.state` event name
      and a JSON payload compliant with `ConnectionStateEvent`.
  queryJobCompleted:
    address: /events
    messages:
      queryJobCompleted:
        $ref: '#/components/messages/QueryJobCompleted'
    description: |
      SSE event fired when a query job execution completes (success, failed, or canceled).
      Uses the `query.job.completed` event name with a JSON payload.
components:
  messages:
    ConnectionState:
      name: connection.state
      title: ConnectionState
      summary: Notifies subscribers about configuration connection lifecycle changes.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ConnectionStateEvent'
    QueryJobCompleted:
      name: query.job.completed
      title: QueryJobCompleted
      summary: Notifies subscribers when a query job execution completes.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/QueryJobCompletedEvent'
  schemas:
    ConnectionStateEvent:
      type: object
      required:
        - configurationName
        - state
      properties:
        configurationName:
          type: string
          description: Name of the configuration as defined in the ori config file.
        state:
          type: string
          description: Current connection state.
          enum:
            - connecting
            - connected
            - failed
        message:
          type: string
          description: Optional status message shown to the user while waiting.
        error:
          type: string
          description: Error text when `state` is `failed`.
    QueryJobCompletedEvent:
      type: object
      required:
        - jobId
        - configurationName
        - status
        - finishedAt
      properties:
        jobId:
          type: string
          description: Unique job identifier.
        configurationName:
          type: string
          description: Name of the configuration used for the query.
        status:
          type: string
          enum:
            - success
            - failed
            - canceled
          description: Final job status.
        finishedAt:
          type: string
          format: date-time
          description: ISO timestamp when job completed.
        durationMs:
          type: integer
          description: Job execution duration in milliseconds.
        error:
          type: string
          description: Error message when status is failed.
        message:
          type: string
          description: Optional user-facing message.
        stored:
          type: boolean
          description: Whether the result was stored in the cache.
